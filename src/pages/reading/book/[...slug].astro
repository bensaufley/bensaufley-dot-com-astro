---
import ArrowLeft from '@phosphor-icons/core/regular/arrow-circle-left.svg';
import type { GetStaticPaths } from 'astro';
import type { AstroComponentFactory } from 'astro/runtime/server/index.js';
import { getCollection, type InferEntrySchema } from 'astro:content';
import dayjs from 'dayjs';
import { basename, extname } from 'path';

import { PER_PAGE } from '~components/reading/Read.astro';
import BaseLayout from '~layouts/BaseLayout.astro';

import styles from '~components/reading/styles.module.css';

const allBooks = (await getCollection('books', (book) => !!book.data.finishedAt)).toSorted((a, b) =>
  dayjs.utc(b.data.finishedAt).diff(a.data.finishedAt, 'day'),
);

export const getStaticPaths: GetStaticPaths = async () => {
  const books = (await getCollection('books', (book) => !!book.data.finishedAt && !!book.body?.trim())).toSorted(
    (a, b) => dayjs.utc(b.data.finishedAt).diff(a.data.finishedAt, 'day'),
  );

  return Promise.all(
    books.map(async (post) => {
      const { Content } = await post.render();

      return {
        post,
        props: { Content, ...post.data },
        params: { slug: basename(post.id, extname(post.id)) },
      };
    }),
  );
};

export type Props = InferEntrySchema<'books'> & {
  Content: AstroComponentFactory;
};

const {
  params: { slug },
  props: { Content, ...book },
} = Astro;

const bookPage =
  allBooks.findIndex(
    (_, index) =>
      index % PER_PAGE === 0 && index + PER_PAGE > allBooks.findIndex((b) => slug === basename(b.id, extname(b.id))),
  ) /
    PER_PAGE +
  1;
---

<BaseLayout url={`/reading/book/${slug}`} title={book.title}>
  <div class={styles.bookReview}>
    {book.coverImageUrl && <img src={book.coverImageUrl} alt={`Cover of ${book.title}`} class={styles.coverImage} />}
    <h2>{book.title}</h2>
    {book.subtitle && <h3>{book.subtitle}</h3>}

    <Content />

    <p>
      <a class={styles.back} href={`/reading/${bookPage === 1 ? '' : bookPage}#${slug}`}><ArrowLeft /> Back</a>
    </p>
  </div>
</BaseLayout>
