---
import type { SvgComponent } from 'astro/types';
import clsx from 'clsx';
import { basename, extname, relative, resolve } from 'node:path';

import Tooltip from '~components/Tooltip';
import type { Frontmatter } from '~lib/pageTypes';

import GitHubLink from '../GitHubLink';
import ThemePicker from '../ThemePicker';

import NavItem from './NavItem.astro';
import SearchItem from './SearchItem';

import styles from './styles.module.css';

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;

const topLevelPages = Object.entries<{ frontmatter: Frontmatter; Icon?: SvgComponent }>(
  import.meta.glob('../../pages/{*.astro,*.md,*.mdx,*/index.astro,*/index.md,*/index.mdx}', {
    eager: true,
  }),
)
  .filter(([filename]) => !/404/.test(filename))
  .map(([filename, { frontmatter: fm, Icon }]) => {
    const path = `/${relative(resolve('../../pages'), filename)}`;
    const ext = extname(path);
    const isIndex = basename(path, ext) === 'index';
    return {
      Icon,
      data: {
        path: path.slice(0, isIndex ? -`index${ext}`.length : -ext.length).replace(/\/?$/, '/'),
        ...fm,
      },
    };
  })
  .toSorted(({ data: a }, { data: b }) => {
    if (a.order === undefined && b.order === undefined) return a.title.localeCompare(b.title);
    if (a.order === undefined) return 1;
    if (b.order === undefined) return -1;
    return a.order - b.order;
  });
---

<header class={clsx('sticky', styles.pageHeader)}>
  <h2 class={styles.name}>
    <a href="/">
      <span class={styles.firstName}>Ben</span>
      <Tooltip client:load content="SOFF-lee" as="span" class={styles.lastName}>Saufley</Tooltip>
    </a>
  </h2>
  <h3 class={styles.position}>
    Software <br class={styles.desktopBreak} />
    Engineering Leader
  </h3>
</header>
<nav class={clsx('sticky', styles.stickyNav)}>
  <a href="/" class={styles.name}> BS</a>
  <div class={styles.ghLink}>
    <GitHubLink client:load />
  </div>
  <ul>
    {topLevelPages.map(({ data, Icon }) => <NavItem currentPath={currentPath} {data} icon={Icon} />)}
  </ul>
  <div class={styles.right}>
    <SearchItem client:only="solid-js" />
    <ThemePicker context="header" client:only="solid-js" invert />
  </div>
</nav>
